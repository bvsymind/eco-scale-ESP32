<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weight Wizard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                        },
                        secondary: {
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .loading-dots span {
            animation: blink 1.4s infinite both;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
    </style>
</head>
<body class="min-h-full bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-primary-600 dark:text-primary-400 mb-2">Weight Wizard</h1>
            <p class="text-gray-600 dark:text-gray-300">Your digital scale sorcerer ü™Ñ</p>
        </header>

        <!-- Main Card -->
        <main class="bg-white dark:bg-gray-800 rounded-xl shadow-xl overflow-hidden backdrop-blur-md bg-opacity-70 dark:bg-opacity-70 border border-gray-200 dark:border-gray-700 transition-all duration-300">
            <!-- Connection Panel -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 rounded-full bg-gray-300 dark:bg-gray-600" id="connectionStatus"></div>
                    <span id="connectionStatusText" class="font-medium">Disconnected</span>
                </div>
                <div class="flex gap-3">
                    <button id="connectBtn" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg flex items-center gap-2 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-400 focus:ring-opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plug">
                            <path d="M12 22v-5"></path>
                            <path d="M9 8V2"></path>
                            <path d="M15 8V2"></path>
                            <path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8z"></path>
                        </svg>
                        Connect
                    </button>
                    <button id="disconnectBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg flex items-center gap-2 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plug">
                            <path d="M12 22v-5"></path>
                            <path d="M9 8V2"></path>
                            <path d="M15 8V2"></path>
                            <path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8z"></path>
                            <line x1="2" y1="2" x2="22" y2="22"></line>
                        </svg>
                        Disconnect
                    </button>
                </div>
            </div>

            <!-- Weight Display -->
            <div class="p-6 flex flex-col items-center justify-center gap-4">
                <div class="text-center mb-4">
                    <div class="text-9xl font-bold text-gray-800 dark:text-white transition-all duration-300" id="weightDisplay">-</div>
                    <div class="flex justify-center gap-2 mt-4">
                        <button id="unitToggle" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-lg">g</button>
                        <button id="resetBtn" class="px-3 py-1 bg-secondary-500 hover:bg-secondary-600 text-white rounded-lg flex items-center gap-1 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rotate-ccw">
                                <polyline points="1 4 1 10 7 10"></polyline>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                            </svg>
                            Tare
                        </button>
                    </div>
                </div>

                <!-- Zoom Controls -->
                <div class="flex gap-2 mb-6">
                    <button data-size="small" class="zoom-btn px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm">S</button>
                    <button data-size="medium" class="zoom-btn px-3 py-1 bg-secondary-500 text-white rounded-lg text-base">M</button>
                    <button data-size="large" class="zoom-btn px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-lg text-lg">L</button>
                </div>
            </div>

            <!-- Log Panel -->
            <div class="border-t border-gray-200 dark:border-gray-700 p-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-medium text-gray-800 dark:text-gray-200">Raw Data Log</h3>
                    <button id="clearLogBtn" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm flex items-center gap-1 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                        Clear
                    </button>
                </div>
                <div id="logArea" class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3 h-48 overflow-y-auto font-mono text-sm text-gray-800 dark:text-gray-300 border border-gray-200 dark:border-gray-700"></div>
            </div>
        </main>

        <!-- Theme Toggle -->
        <div class="mt-6 flex justify-center">
            <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 transition-colors">
                <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const weightDisplay = document.getElementById('weightDisplay');
        const unitToggle = document.getElementById('unitToggle');
        const resetBtn = document.getElementById('resetBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const logArea = document.getElementById('logArea');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionStatusText = document.getElementById('connectionStatusText');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const zoomButtons = document.querySelectorAll('.zoom-btn');

        // State
        let port;
        let reader;
        let keepReading = false;
        let connected = false;
        let currentUnit = localStorage.getItem('weightUnit') || 'g';
        let tareValue = 0;
        let fontSize = 'medium';
        let rawValueFromSensor = 0;

        // Initialize
        function init() {
            // Set up event listeners
            connectBtn.addEventListener('click', handleConnect);
            disconnectBtn.addEventListener('click', handleDisconnect);
            unitToggle.addEventListener('click', toggleUnit);
            resetBtn.addEventListener('click', handleReset);
            clearLogBtn.addEventListener('click', clearLog);
            themeToggle.addEventListener('click', toggleTheme);
            
            zoomButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    fontSize = btn.dataset.size;
                    updateWeightDisplaySize();
                    zoomButtons.forEach(b => {
                        if (b === btn) {
                            b.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                            b.classList.add('bg-secondary-500', 'text-white');
                        } else {
                            b.classList.remove('bg-secondary-500', 'text-white');
                            b.classList.add('bg-gray-200', 'dark:bg-gray-700');
                        }
                    });
                });
            });

            // Set initial unit
            unitToggle.textContent = currentUnit;
            
            // Check for dark mode preference
            if (localStorage.getItem('darkMode') === 'true' || 
                (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                themeIcon.setAttribute('data-feather', 'moon');
            } else {
                themeIcon.setAttribute('data-feather', 'sun');
            }
            
            feather.replace();
        }

        // Connection handling
        async function handleConnect() {
            if (!navigator.serial) {
                logToConsole('Web Serial API not supported in this browser.');
                updateConnectionStatus('error', 'Not supported');
                return;
            }

            try {
                updateConnectionStatus('connecting', 'Connecting...');
                
                // Show connecting state
                connectBtn.innerHTML = `
                    <span class="loading-dots">
                        <span>.</span><span>.</span><span>.</span>
                    </span>
                    Connecting
                `;
                connectBtn.disabled = true;
                
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });

                logToConsole('‚úÖ Serial port opened.');

                // Use TextDecoderStream for better data handling (from index.html)
                const decoder = new TextDecoderStream();
                port.readable.pipeTo(decoder.writable);
                const inputStream = decoder.readable;

                reader = inputStream.getReader();
                connected = true;
                keepReading = true;
                updateConnectionStatus('connected', 'Connected');
                
                connectBtn.style.display = 'none';
                disconnectBtn.disabled = false;
                
                // Start reading data with improved parsing (from index.html)
                readLoop();
            } catch (error) {
                logToConsole(`Connection error: ${error.message}`);
                updateConnectionStatus('error', 'Connection failed');
                resetConnectButton();
            }
        }

        async function handleDisconnect() {
            try {
                keepReading = false;
                if (reader) {
                    await reader.cancel();
                    await reader.releaseLock();
                    reader = null;
                }
                if (port) {
                    await port.close();
                    port = null;
                }
                
                connected = false;
                updateConnectionStatus('disconnected', 'Disconnected');
                disconnectBtn.disabled = true;
                connectBtn.style.display = 'flex';
                resetConnectButton();
                
                logToConsole('üîå Serial port closed.');
            } catch (error) {
                logToConsole(`Disconnection error: ${error.message}`);
            }
        }

        // Data reading with improved parsing (from index.html)
        async function readLoop() {
            let buffer = '';
            try {
                while (keepReading && reader) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    if (value) {
                        buffer += value;
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // last partial line
                        
                        for (const line of lines) {
                            const trimmed = line.trim();
                            if (trimmed) {
                                logToConsole('Raw: ' + trimmed);
                                
                                // Improved parsing from index.html
                                const num = parseFloat(trimmed);
                                if (!isNaN(num)) {
                                    rawValueFromSensor = num;
                                    const displayValue = rawValueFromSensor - tareValue;
                                    updateWeightDisplay(displayValue);
                                } else {
                                    logToConsole(`‚ö†Ô∏è Invalid data: "${trimmed}"`);
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                logToConsole(`Read error: ${error.message}`);
                if (connected) {
                    await handleDisconnect();
                }
            }
        }

        // UI Updates
        function updateWeightDisplay(value) {
            let displayValue;
            
            // Convert based on unit
            switch (currentUnit) {
                case 'kg':
                    displayValue = (value / 1000).toFixed(3);
                    break;
                case 'lbs':
                    displayValue = (value * 0.00220462).toFixed(3);
                    break;
                default: // g
                    displayValue = value.toFixed(2);
            }
            
            weightDisplay.textContent = displayValue;
        }

        function updateWeightDisplaySize() {
            weightDisplay.className = 'text-center font-bold transition-all duration-300';
            
            switch (fontSize) {
                case 'small':
                    weightDisplay.classList.add('text-5xl', 'text-gray-800', 'dark:text-white');
                    break;
                case 'medium':
                    weightDisplay.classList.add('text-7xl', 'text-gray-800', 'dark:text-white');
                    break;
                case 'large':
                    weightDisplay.classList.add('text-9xl', 'text-gray-800', 'dark:text-white');
                    break;
            }
        }

        function updateConnectionStatus(status, text) {
            connectionStatusText.textContent = text;
            
            switch (status) {
                case 'connected':
                    connectionStatus.classList.remove('bg-gray-300', 'bg-yellow-400', 'bg-red-500');
                    connectionStatus.classList.add('bg-green-500');
                    break;
                case 'connecting':
                    connectionStatus.classList.remove('bg-gray-300', 'bg-green-500', 'bg-red-500');
                    connectionStatus.classList.add('bg-yellow-400');
                    break;
                case 'error':
                    connectionStatus.classList.remove('bg-gray-300', 'bg-green-500', 'bg-yellow-400');
                    connectionStatus.classList.add('bg-red-500');
                    break;
                default: // disconnected
                    connectionStatus.classList.remove('bg-green-500', 'bg-yellow-400', 'bg-red-500');
                    connectionStatus.classList.add('bg-gray-300', 'dark:bg-gray-600');
            }
        }

        // Unit conversion
        function toggleUnit() {
            switch (currentUnit) {
                case 'g':
                    currentUnit = 'kg';
                    break;
                case 'kg':
                    currentUnit = 'lbs';
                    break;
                case 'lbs':
                    currentUnit = 'g';
                    break;
            }
            
            unitToggle.textContent = currentUnit;
            localStorage.setItem('weightUnit', currentUnit);
            
            // Force update of displayed value
            const displayValue = rawValueFromSensor - tareValue;
            updateWeightDisplay(displayValue);
        }

        // Reset (tare)
        function handleReset() {
            tareValue = rawValueFromSensor;
            logToConsole(`Tare set to ${tareValue.toFixed(2)}g`);
            updateWeightDisplay(0);
        }

        // Logging
        function logToConsole(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            logArea.innerHTML = '';
        }

        // Theme handling
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
                themeIcon.setAttribute('data-feather', 'sun');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
                themeIcon.setAttribute('data-feather', 'moon');
            }
            feather.replace();
        }

        // Helper functions
        function resetConnectButton() {
            connectBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plug">
                    <path d="M12 22v-5"></path>
                    <path d="M9 8V2"></path>
                    <path d="M15 8V2"></path>
                    <path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8z"></path>
                </svg>
                Connect
            `;
            connectBtn.disabled = false;
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <script>feather.replace();</script>
</body>
</html>